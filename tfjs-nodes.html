<!-- Node Configuration Templates -->
<script type="text/html" data-template-name="tensorflowPredict">
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-file"></i> Mode</label>
        <select style="width: 160px;" type="text" id="node-input-mode">
            <option value="online" selected> Online</option>
            <option value="local"> Local</option>
        </select>
    </div>

    <div class="node-row-msg-online">
        <div class="form-row node-row-online">
            <label for="node-input-modelUrl" style="margin-left: 20px; width: 80px;"><i class="fa fa-globe"></i> New URL</label>
            <input type="text" id="node-input-modelUrl" placeholder="https://../model.json">
        </div>
    </div>  

    <div class="node-row-msg-local">
        <div class="form-row node-row-local">
            <label for="node-input-localModel" style="margin-left: 20px; width: 80px;"><i class="fa fa-floppy-o"></i> Model</label>
                <select style="width: 160px;" type="text" id="node-input-localModel">
                    <option value="model1" selected> Not supported yet</option>
                </select>
        </div>       
    </div>
    <div class="form-row node-row-parameters">
        <label for="node-input-parameters"><i class="fa fa-cog"></i> Parameters</label>
        <div class="form-row node-row-threshold">
            <label style="margin-left: 20px; width: 140px;" for="node-input-threshold"><i class="fa fa-signal"></i> Threshold (%)</label>
            <input type="text" id="node-input-threshold" style="width: 50px;" placeholder="0-100">  <i>(Not supported yet)</i>
        </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/html" data-template-name="tensorflowMobilenet">
    <div class="form-row">
        <label for="node-input-modelUrl"><i class="fa fa-globe"></i> Model Url</label>
        <input type="text" id="node-input-modelUrl" placeholder="leave blank to load default model from internet">
    </div>
    <div class="form-row node-row-parameters">
        <label for="node-input-parameters"><i class="fa fa-cog"></i> Parameters</label>
        <div class="form-row node-row-threshold">
            <label style="margin-left: 20px; width: 140px;" for="node-input-threshold"><i class="fa fa-signal"></i> Threshold (%)</label>
            <input type="text" id="node-input-threshold" style="width: 50px;" placeholder="0-100">
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-passthru"><i class="fa fa-picture-o"></i> Image</label>
        <input type="checkbox" id="node-input-passthru" style="display:inline-block; width:20px; vertical-align:baseline;">
        pass original image through as <code>msg.image</code>.
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/html" data-template-name="tensorflowCocoSsd">
    <div class="form-row">
        <label for="node-input-modelUrl"><i class="fa fa-globe"></i> Model Url</label>
        <input type="text" id="node-input-modelUrl" placeholder="leave blank to load default model from internet">
    </div>
    <div class="form-row node-row-parameters">
        <label for="node-input-parameters"><i class="fa fa-cog"></i> Parameters</label>
        <div class="form-row node-row-threshold">
            <label style="margin-left: 20px; width: 140px;" for="node-input-threshold"><i class="fa fa-signal"></i> Threshold (%)</label>
            <input type="text" id="node-input-threshold" style="width: 50px;" placeholder="0-100">
        </div>
        <div class="form-row node-row-maxDetections">
            <label style="margin-left: 20px; width: 140px;" for="node-input-maxDetections"><i class="fa fa-object-ungroup"></i> Max. Detections</label>
            <input type="text" id="node-input-maxDetections" style="width: 50px;" placeholder="0-10">
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-passthru"><i class="fa fa-picture-o"></i> Image</label>
        <input type="checkbox" id="node-input-passthru" style="display:inline-block; width:20px; vertical-align:baseline;">
        pass original image through as <code>msg.image</code>.
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/html" data-template-name="tensorflowPosenet">
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-file"></i> Mode</label>
        <select style="width: 160px;" type="text" id="node-input-mode">
            <option value="online" selected> Online</option>
            <option value="local"> Local</option>
        </select>
    </div>

    <div class="node-row-msg-online">
        <div class="form-row node-row-online">
            <label for="node-input-modelUrl" style="margin-left: 20px; width: 80px;"><i class="fa fa-globe"></i> New URL</label>
            <input type="text" id="node-input-modelUrl" placeholder="https://../model.json">
        </div>
    </div>  

    <div class="node-row-msg-local">
        <div class="form-row node-row-local">
            <label for="node-input-localModel" style="margin-left: 20px; width: 80px;"><i class="fa fa-floppy-o"></i> Model</label>
                <select style="width: 160px;" type="text" id="node-input-localModel">
                    <option value="posenet" selected> Not supported yet</option>
                </select>
        </div>       
    </div>
    <div class="form-row node-row-parameters">
        <label for="node-input-parameters"><i class="fa fa-cog"></i> Parameters</label>
        <div class="form-row node-row-threshold">
            <label style="margin-left: 20px; width: 140px;" for="node-input-threshold"><i class="fa fa-signal"></i> Threshold (%)</label>
            <input type="text" id="node-input-threshold" style="width: 50px;" placeholder="0-100">
        </div>
        <div class="form-row node-row-maxDetections">
            <label style="margin-left: 20px; width: 140px;" for="node-input-maxDetections"><i class="fa fa-object-ungroup"></i> Max. Detections</label>
            <input type="text" id="node-input-maxDetections" style="width: 50px;" placeholder="0-10">
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<!-- Information Help Menu -->
<script type="text/html" data-help-name="tensorflowPredict">
    <p>A <a href="https://www.tensorflow.org/js" target = "_new">tensorflow.js</a> node to run <code>tf.predict()</code> against models.</p>
    <p>Default Model used is an Imagenet online Model (Mobilenets V1) (internet access required), but can be pointed to a local tensorflow.js model file, such as one converted from 
    <a href="https://www.tensorflow.org/js/tutorials/conversion/import_keras" target="_new">Keras</a>.</p>   
</script>

<script type="text/html" data-help-name="tensorflowMobilenet">
    <p>A <a href="https://www.tensorflow.org/js" target = "_new">tensorflow.js</a> node to run Mobilenets V2 pretrained model.</p>
    <h3>Inputs</h3>
      <dl class="message-properties">
        <dt>payload<span class="property-type">buffer | string</span></dt>
        <dd>A binary buffer of a jpeg image, or string of a filename to load.</dd>
      </dl>
    <h3>Outputs</h3>
      <dl class="message-properties">    
        <dt>payload<span class="property-type">array</span></dt>
        <dd>Top-3 array of objects exceeding threshold containing</dd>
        <dd>
          <ul>
            <li><code>class</code> <i>string</i></li>
            <li><code>score</code> <i>float</i></li>
          </ul>
        </dd>
      </dl>
    <h3>Details</h3>
    <p>The threshold can be overridden dynamically by setting the appropriate msg property.</p>
    <p>By default the node uses a local copy of the CoCo SSD model - if you leave the field blank it will load the default model from the internet.</p>
</script>

<script type="text/html" data-help-name="tensorflowCocoSsd">
    <p>A <a href="https://www.tensorflow.org/js" target = "_new">tensorflow.js</a> node to run COCO Simple Shot Detector on images.</p>
    <h3>Inputs</h3>
      <dl class="message-properties">
        <dt>payload<span class="property-type">buffer | string</span></dt>
        <dd>A binary buffer of a jpeg image, or string of a filename to load.</dd>
        <dt>threshold<span class="property-type">number</span></dt>
        <dd>Threshold in % for a valid detection between 0 and 100 <i>(optional)</i></dd>
        <dt>maxDetections <span class="property-type">number</span></dt>
        <dd>Maximum number of persons to detect between 0 and 10 <i>(optional)</i></dd>
      </dl>
    <h3>Outputs</h3>
      <dl class="message-properties">    
        <dt>payload <span class="property-type">array</span></dt>
        <dd>An array of detected objects, containing
          <ul>
            <li><code>bbox</code> array, [x, y, w, h]</li>
            <li><code>class</code> string, detected object class name</li>
            <li><code>score</code> number, 0 -> 1</li>
          </ul>
        </dd>
        <dt>classes <span class="property-type">object</span></dt>
        <dd>An object with each class and their counts, e.g. <code>{cat:1, dog:2}</code>.</dd>
      </dl>  
    <h3>Details</h3> 
      <p>Both the configured threshold and maxDetections can be overridden dynamically by setting the appropriate msg property.</p>
      <p>By default the node uses a local copy of the CoCo SSD model - if you leave the field blank it will load the default model from the internet.</p>
</script>

<script type="text/html" data-help-name="tensorflowPosenet">
    <p>A <a href="https://www.tensorflow.org/js" target = "_new">tensorflow.js</a> node to run Pose Estimator against an image.</p>
    <h3>Inputs</h3>
      <dl class="message-properties">
        <dt>payload <span class="property-type">buffer | string</span></dt>
        <dd>A binary buffer of a jpeg image, or string of a filename to load.</dd>
        <dt>threshold<span class="property-type">number</span></dt>
        <dd>Threshold in % for a valid detection between 0 and 100 <i>(optional)</i></dd>
        <dt>maxDetections<span class="property-type">number</span></dt>
        <dd>Maximum number of persons to detect between 0 and 10 <i>(optional)</i></dd>
      </dl>
    <h3>Outputs</h3>
      <dl class="message-properties">    
        <dt>payload <span class="property-type">array</span></dt>
        <dd>an array of detected objects, containing
          <ul>
            <li><code>score</code> number, 0 -> 1.</li>
            <li><code>keypoints</code> array[17],  body parts objects including score, part, and position: x and y.</li>
          </ul>
        </dd>
    </dl> 
    <h3>Details</h3> 
      <p>Both the configured threshold and maxDetections can be overridden dynamically by setting the appropriate msg property.</p>
</script>  

<!-- Node JavaScript Registration -->
<script type="text/javascript">
    RED.nodes.registerType('tensorflowPredict', {
        category: 'analysis-function',
        defaults: {
            name: { value: '' },
            mode: { value: 'online' },
            modelUrl: { value: 'https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json', required: true },
            localModel: { value: 'model1' },
            threshold: { value: 50, validate: function(v) { return RED.validators.number(v) && (v > 0) && (v < 100) }},
        },
        inputs: 1,
        outputs: 1,
        color: '#ED782F',
        icon: 'tensorflow_logo.png',
        label: function() { return this.name || 'tf predict' },
        paletteLabel: 'tf predict',
        oneditprepare: function() {
            $("#node-input-threshold").spinner({ min: 0, max: 100})
            $("#node-input-mode").on("change", function(e) {
                var val = $(this).val()
                $(".node-row-msg-online").toggle(val==="online")
                $(".node-row-msg-local").toggle(val==="local")
            })
        }
    })
</script>

<script type="text/javascript">
    RED.nodes.registerType('tensorflowMobilenet',{
        category: 'analysis-function',
        defaults: {
            name: { value: '' },
            modelUrl: { value: "http://localhost:1880"+RED.settings.httpNodeRoot+"mobilenet/model.json"  }, // https://storage.googleapis.com/tfjs-models/savedmodel/mobilenet_v2_1.0_224/model.json
            threshold: { value: 25, validate: function(v) { return RED.validators.number(v) && (v > 0) && (v < 100) }},
            passthru: { value: false }
        },
        inputs: 1,
        outputs: 1,
        color: '#ED782F',
        icon: 'tensorflow_logo.png',
        label: function() { return this.name || 'tf mobilenet' },
        paletteLabel: 'tf mobilenet',
        oneditprepare: function() {
            $("#node-input-threshold").spinner({ min: 0, max: 100})
        }
    })
</script>

<script type="text/javascript">
    RED.nodes.registerType('tensorflowCocoSsd', {
        category: 'analysis-function',
        defaults: {
            name: { value: '' },
            mode: { value: 'local' },
            // localModel: { value: 'coco-ssd' },
            modelUrl: { value: "http://localhost:1880"+RED.settings.httpNodeRoot+"coco/model.json" },
            threshold: { value: 50, validate: function(v) { return RED.validators.number(v) && (v > 0) && (v < 100) }},
            maxDetections: { value: 4, validate: function(v) { return RED.validators.number(v) && (v >= 1) && (v <= 10) }},
            passthru: { value: false }
        },
        inputs: 1,
        outputs: 1,
        color: '#ED782F',
        icon: 'tensorflow_logo.png',
        label: function() { return this.name || 'tf coco ssd' },
        paletteLabel: 'tf coco ssd',
        oneditprepare: function() {
            $("#node-input-threshold").spinner({ min: 0, max: 100})
            $("#node-input-maxDetections").spinner({ min: 1, max: 10})
        }
    })
</script>

<script type="text/javascript">
    RED.nodes.registerType('tensorflowPosenet', {
        category: 'analysis-function',
        defaults: {
            name: { value: '' },
            mode: { value: 'online' },
            modelUrl: { value: '' },
            localModel: { value: 'posenet' },
            threshold: { value: 50, validate: function(v) { return RED.validators.number(v) && (v > 0) && (v < 100) }},
            maxDetections: { value: 4, validate: function(v) { return RED.validators.number(v) && (v >= 1) && (v <= 10) }}
        },
        inputs: 1,
        outputs: 1,
        color: '#ED782F',
        icon: 'tensorflow_logo.png',
        label: function() { return this.name || 'tf posenet' }, 
        paletteLabel: 'tf posenet',
        oneditprepare: function() {
            $("#node-input-threshold").spinner({ min: 0, max: 100})
            $("#node-input-maxDetections").spinner({ min: 1, max: 10})
            $("#node-input-mode").on("change", function(e) {
                var val = $(this).val()
                $(".node-row-msg-online").toggle(val==="online")
                $(".node-row-msg-local").toggle(val==="local")
            })
        }
    })
</script>